<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Your Cart - Kyla & Co</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        font-family: Inter, sans-serif;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        background: #f8f8fb;
      }
      h1 {
        text-align: center;
        font-family: "Playfair Display", serif;
      }
      .cart-wrapper {
        max-width: 820px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      }
      ul#cart-items {
        list-style: none;
        padding: 0;
        margin: 0 0 12px 0;
      }
      ul#cart-items li {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #eee;
        align-items: center;
      }
      .cart-totals {
        background: #fff7f7;
        padding: 14px;
        border-radius: 8px;
        margin-top: 12px;
      }
      .cart-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 16px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-primary {
        background: #ff6f61;
        color: #fff;
      }
      .btn-muted {
        background: #888;
        color: #fff;
      }
      .empty {
        text-align: center;
        color: #777;
        padding: 24px 0;
      }
      .msg {
        text-align: center;
        margin-top: 12px;
        color: #b00;
        white-space: pre-wrap;
      }
      .checkout-form {
        text-align: center;
        margin-top: 12px;
      }
      .checkout-form input[type="email"] {
        padding: 8px;
        width: 280px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }
      @media (max-width: 480px) {
        ul#cart-items li {
          flex-direction: column;
          align-items: flex-start;
        }
        .cart-actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <h1>Your Cart</h1>

    <div class="cart-wrapper">
      <ul id="cart-items"></ul>

      <div class="cart-totals">
        <div>Subtotal: R<span id="subtotal">0.00</span></div>
        <div>Shipping: R<span id="shipping">0.00</span></div>
        <h3>Total: R<span id="total">0.00</span></h3>
      </div>

      <div class="cart-actions">
        <a class="btn" href="index.html">Continue Shopping</a>
        <button id="clear-cart-btn" class="btn btn-muted">Clear Cart</button>
        <button id="checkout-btn" class="btn btn-primary">Checkout</button>
      </div>

      <div id="cart-message" class="msg"></div>
    </div>

    <script>
      const STORAGE_KEY = "shopCart";
      const CREATE_SNAPSCAN_URL =
        "http://localhost:4242/create-snapscan-session"; // backend: create SnapScan checkout

      async function createSnapscanSession(cart, email) {
        const res = await fetch(CREATE_SNAPSCAN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cart, email }),
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok)
          throw new Error(body.error || body.message || `status ${res.status}`);
        return body;
      }

      function formatCurrency(n) {
        return Number(n).toFixed(2);
      }

      function showMessage(text, timeout = 3500) {
        const el = document.getElementById("cart-message");
        el.textContent = text || "";
        if (!text) return;
        clearTimeout(el._t);
        el._t = setTimeout(() => (el.textContent = ""), timeout);
      }

      function getCart() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch {
          return [];
        }
      }

      function saveCart(cart) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
      }

      function removeItemAt(index) {
        const cart = getCart();
        if (index < 0 || index >= cart.length) return;
        cart.splice(index, 1);
        saveCart(cart);
        updateCartDisplay();
      }

      function computeTotals(cart) {
        let subtotal = 0;
        for (const item of cart) {
          const price = Number(item.price) || 0;
          const qty = Number(item.quantity) || 1;
          subtotal += price * qty;
        }
        // Fixed shipping at R100 (not R60)
        const shipping = cart.length ? 100 : 0;
        const total = subtotal + shipping;

        // Format numbers to prevent RNaN
        return {
          subtotal: Number(subtotal).toFixed(2),
          shipping: Number(shipping).toFixed(2),
          total: Number(total).toFixed(2),
        };
      }

      function updateCartDisplay() {
        const cart = getCart();
        const list = document.getElementById("cart-items");
        list.innerHTML = "";

        if (!cart || cart.length === 0) {
          list.innerHTML = "<li class='empty'>Your cart is empty.</li>";
          // Set zeros when cart is empty
          document.getElementById("subtotal").textContent = "0.00";
          document.getElementById("shipping").textContent = "0.00";
          document.getElementById("total").textContent = "0.00";
        } else {
          // Show items
          cart.forEach((item) => {
            const li = document.createElement("li");
            const itemTotal = (
              Number(item.price) * Number(item.quantity)
            ).toFixed(2);
            li.innerHTML = `
              <span>${item.name} Ã— ${item.quantity}</span>
              <span>R${itemTotal}</span>
            `;
            list.appendChild(li);
          });

          // Update totals
          const totals = computeTotals(cart);
          document.getElementById("subtotal").textContent = totals.subtotal;
          document.getElementById("shipping").textContent = totals.shipping;
          document.getElementById("total").textContent = totals.total;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateCartDisplay();

        document
          .getElementById("clear-cart-btn")
          .addEventListener("click", () => {
            localStorage.removeItem(STORAGE_KEY);
            updateCartDisplay();
            showMessage("Cart cleared.");
          });

        document
          .getElementById("checkout-btn")
          .addEventListener("click", function () {
            const cart = getCart();
            if (!cart.length) {
              alert("Cart is empty.");
              return;
            }
            const emailInput = document.getElementById("payer-email");
            const email =
              emailInput && emailInput.value && emailInput.value.trim();

            // save checkout data to sessionStorage and redirect to checkout page
            sessionStorage.setItem(
              "checkoutData",
              JSON.stringify({ cart, email })
            );
            window.location.href = "checkout.html";
          });
      });
    </script>
  </body>
</html>
